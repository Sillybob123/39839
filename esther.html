<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book of Esther — Megillat Esther | A Letter in the Scroll</title>
    <meta name="description" content="Read the complete Book of Esther in Hebrew and English. All 10 chapters of Megillat Esther with the Revised JPS 2023 translation. React, bookmark, and save your favourite verses.">
    <link rel="icon" type="image/png" href="media/images/Icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600;700;800&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/purim.css">
</head>
<body class="esther-reader-body">

    <!-- Back navigation -->
    <nav class="esther-back-nav">
        <a href="purim.html" class="esther-back-link">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="15 18 9 12 15 6"/></svg>
            Purim
        </a>
        <span class="esther-back-title" aria-hidden="true">
            <span class="esther-back-title-he">מְגִלַּת אֶסְתֵּר</span>
            <span class="esther-back-title-sep">·</span>
            <span>Book of Esther</span>
        </span>
        <a href="index.html" class="esther-back-home">Home</a>
    </nav>

    <main class="esther-page-main">
        <section class="megillah-section" aria-labelledby="megillah-heading">

            <!-- Corner decorative images -->
            <img src="media/images/noiser1.jpg"       alt="" class="megillah-deco megillah-deco--tl" aria-hidden="true">
            <img src="media/images/noiser2.png"       alt="" class="megillah-deco megillah-deco--tr" aria-hidden="true">
            <img src="media/images/hamantashen1.png"  alt="" class="megillah-deco megillah-deco--bl" aria-hidden="true">
            <img src="media/images/hamantaschen2.png" alt="" class="megillah-deco megillah-deco--br" aria-hidden="true">

            <!-- Header (navy banner) -->
            <div class="megillah-header">
                <p class="megillah-eyebrow">Read the Megillah</p>
                <span class="megillah-title-hebrew">מְגִלַּת אֶסְתֵּר</span>
                <div class="megillah-header-divider" aria-hidden="true">
                    <span class="megillah-header-divider-line"></span>
                    <img src="media/images/noiser2.png" alt="" class="megillah-header-divider-img">
                    <span class="megillah-header-divider-line"></span>
                </div>
                <h1 id="megillah-heading">The Book of Esther</h1>
                <p class="megillah-subtitle">Complete Text &nbsp;&middot;&nbsp; All Ten Chapters &nbsp;&middot;&nbsp; Hebrew &amp; English (Revised JPS, 2023)</p>
                <p class="megillah-intro-note">Choose a chapter or read straight through.</p>
                <div class="megillah-header-decos" aria-hidden="true">
                    <img src="media/images/mask.png"         alt="">
                    <img src="media/images/noiser1.jpg"       alt="">
                    <img src="media/images/hamantashen1.png"  alt="">
                    <img src="media/images/hamantaschen2.png" alt="">
                    <img src="media/images/noiser2.png"       alt="">
                    <img src="media/images/mask2.png"         alt="">
                </div>
            </div>

            <!-- Chapter navigation -->
            <nav class="megillah-chapters" aria-label="Select a chapter of Megillat Esther">
                <button class="megillah-ch-btn" data-ch="1">Chapter 1</button>
                <button class="megillah-ch-btn" data-ch="2">Chapter 2</button>
                <button class="megillah-ch-btn" data-ch="3">Chapter 3</button>
                <button class="megillah-ch-btn" data-ch="4">Chapter 4</button>
                <button class="megillah-ch-btn" data-ch="5">Chapter 5</button>
                <button class="megillah-ch-btn" data-ch="6">Chapter 6</button>
                <button class="megillah-ch-btn" data-ch="7">Chapter 7</button>
                <button class="megillah-ch-btn" data-ch="8">Chapter 8</button>
                <button class="megillah-ch-btn" data-ch="9">Chapter 9</button>
                <button class="megillah-ch-btn" data-ch="10">Chapter 10</button>
                <button class="megillah-all-btn active" data-ch="all">All Chapters</button>
            </nav>

            <!-- Auth banner — shown when user is not signed in -->
            <div id="esther-auth-banner" class="esther-auth-banner" hidden>
                <svg viewBox="0 0 20 20" aria-hidden="true" width="18" height="18" style="flex-shrink:0">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" fill="currentColor"/>
                </svg>
                <span><a href="index.html" style="color:inherit;font-weight:700;text-decoration:underline">Sign in</a> to save your reactions and bookmarks across all your devices</span>
            </div>

            <!-- Verse display area -->
            <div id="megillah-content" class="megillah-content" role="region" aria-live="polite">
                <p class="megillah-loading">Loading Megillat Esther&hellip;</p>
            </div>

            <!-- Commentary modal -->
            <div id="esther-commentary-modal" class="esther-commentary-modal" hidden role="dialog" aria-modal="true" aria-labelledby="esther-commentary-title">
                <div class="esther-commentary-panel">
                    <div class="esther-commentary-header">
                        <h2 id="esther-commentary-title">Commentary</h2>
                        <button id="esther-commentary-close" class="esther-commentary-close" type="button" aria-label="Close commentary">×</button>
                    </div>
                    <div id="esther-commentary-body" class="esther-commentary-body"></div>
                </div>
            </div>

            <!-- Source credit -->
            <p class="megillah-credit">
                Text courtesy of <a href="https://www.sefaria.org/Esther" target="_blank" rel="noopener noreferrer">Sefaria</a>
                &nbsp;&middot;&nbsp; Revised JPS Translation, 2023 &nbsp;&middot;&nbsp; Reactions saved to your account
            </p>

        </section>
    </main>

    <footer class="purim-footer">
        <p>
            <a href="purim.html">← Back to Purim</a>
            &nbsp;&middot;&nbsp;
            <a href="purim-story.html">Read the Purim Story</a>
            &nbsp;&middot;&nbsp;
            <a href="index.html">Return to A Letter in the Scroll</a>
        </p>
    </footer>

    <audio id="esther-noiser-audio" preload="auto" playsinline>
        <source src="media/audio/Noisersound.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
    import {
        auth,
        submitReaction,
        getReactionCountsForBook,
        getUserReactions,
        getBookmarkCountsForBook,
        getUserBookmarksForVerses,
        addBookmark,
        removeBookmark
    } from './js/firebase.js';

    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    /* ── Constants ──────────────────────────────────────────────── */
    const chapterNamesHe = [
        '', 'פֶּרֶק א', 'פֶּרֶק ב', 'פֶּרֶק ג', 'פֶּרֶק ד',
        'פֶּרֶק ה', 'פֶּרֶק ו', 'פֶּרֶק ז', 'פֶּרֶק ח',
        'פֶּרֶק ט', 'פֶּרֶק י'
    ];
    const NOISER_AUDIO_FALLBACKS = [
        'media/audio/Noisersound1.mp3',
        'media/audio/Noisersound.mp3'
    ];
    const HAMAN_REGEX = /\bHaman\b/gi;
    const icons = [
        'media/images/noiser1.jpg', 'media/images/hamantashen1.png', 'media/images/mask.png',
        'media/images/noiser2.png', 'media/images/hamantaschen2.png', 'media/images/mask2.png'
    ];

    /* ── State ──────────────────────────────────────────────────── */
    let bookData        = null;
    let currentUser     = null;
    // { "Esther 1:1": { emphasize: true, heart: true } }
    let reactionState   = {};
    // { "Esther 1:1": true }
    let bookmarkState   = {};
    // { "Esther 1:1": { emphasize: 3, heart: 7 } }
    let communityCounts = {};
    // { "Esther 1:1": 2 }
    let communityBkCounts = {};
    // { "Esther 1:1": [{ source, text }, ...] }
    let commentaryByRef = {};
    let noiserAudio = null;
    let noiserHandlersBound = false;
    let noiserSourceIndex = 0;

    /* ── DOM refs ───────────────────────────────────────────────── */
    const content    = document.getElementById('megillah-content');
    const navBtns    = document.querySelectorAll('[data-ch]');
    const authBanner = document.getElementById('esther-auth-banner');
    const commentaryModal = document.getElementById('esther-commentary-modal');
    const commentaryTitle = document.getElementById('esther-commentary-title');
    const commentaryBody = document.getElementById('esther-commentary-body');
    const commentaryClose = document.getElementById('esther-commentary-close');
    const noiserAudioEl = document.getElementById('esther-noiser-audio');

    /* ── Helpers ────────────────────────────────────────────────── */
    function ref(chNum, verseNum) { return `Esther ${chNum}:${verseNum}`; }

    function esc(s) {
        return String(s ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

    function fmtCount(n) { return (n && n > 0) ? String(n) : ''; }

    function renderEnglishWithNoiser(english, verseRef) {
        const safeEnglish = esc(english || '');
        return safeEnglish.replace(
            HAMAN_REGEX,
            (match) =>
                `${match}<button type="button" class="mgv-haman-noiser" data-ref="${verseRef}" aria-label="Play noiser sound for Haman" title="Play noiser sound"><img src="media/images/noiser2.png" alt="" aria-hidden="true"></button>`
        );
    }

    function getCommentaryEntries(verseRef) {
        const raw = commentaryByRef[verseRef];
        if (!Array.isArray(raw)) return [];
        return raw
            .map((entry) => {
                if (!entry || typeof entry !== 'object') return null;
                const source = (typeof entry.source === 'string' && entry.source.trim())
                    ? entry.source.trim()
                    : 'Commentary';
                const text = (typeof entry.text === 'string' && entry.text.trim())
                    ? entry.text.trim()
                    : ((typeof entry.explanation === 'string' && entry.explanation.trim())
                        ? entry.explanation.trim()
                        : '');
                if (!text) return null;
                return { source, text };
            })
            .filter(Boolean);
    }

    function openCommentaryModal(verseRef) {
        const entries = getCommentaryEntries(verseRef);
        if (!entries.length) return;

        commentaryTitle.textContent = `${verseRef} Commentary`;
        commentaryBody.innerHTML = entries.map((entry, index) => {
            const source = esc(entry.source || `Commentary ${index + 1}`);
            const text = esc(entry.text || '').replace(/\n/g, '<br>');
            return `<article class="esther-commentary-entry"><h3>${source}</h3><p>${text}</p></article>`;
        }).join('');

        commentaryModal.hidden = false;
        requestAnimationFrame(() => commentaryModal.classList.add('open'));
        commentaryClose?.focus({ preventScroll: true });
    }

    function closeCommentaryModal() {
        commentaryModal.classList.remove('open');
        window.setTimeout(() => {
            if (!commentaryModal.classList.contains('open')) {
                commentaryModal.hidden = true;
                commentaryBody.innerHTML = '';
            }
        }, 150);
    }

    function setupCommentaryModal() {
        commentaryClose?.addEventListener('click', closeCommentaryModal);
        commentaryModal?.addEventListener('click', (event) => {
            if (event.target === commentaryModal) {
                closeCommentaryModal();
            }
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !commentaryModal.hidden) {
                closeCommentaryModal();
            }
        });
    }

    function setNoiserSource(audio, index) {
        const nextIndex = Math.min(index, NOISER_AUDIO_FALLBACKS.length - 1);
        const nextSrc = NOISER_AUDIO_FALLBACKS[nextIndex];
        noiserSourceIndex = nextIndex;

        if (!audio) return;
        // audio.src is always an absolute URL; resolve nextSrc before comparing
        const resolvedSrc = new URL(nextSrc, window.location.href).href;
        if (audio.src === resolvedSrc) return;

        audio.src = nextSrc;
        if (typeof audio.load === 'function') {
            try {
                audio.load();
            } catch (err) {
                console.warn('Unable to load noiser source:', nextSrc, err);
            }
        }
    }

    function initNoiserAudio() {
        if (noiserAudio) return noiserAudio;
        noiserAudio = noiserAudioEl || new Audio();
        noiserAudio.preload = 'auto';
        noiserAudio.playsInline = true;
        setNoiserSource(noiserAudio, 0);
        return noiserAudio;
    }

    function tryPlayNoiser(audio, sourceIndex) {
        setNoiserSource(audio, sourceIndex);
        try {
            audio.pause();
            audio.currentTime = 0;
            const p = audio.play();
            if (p && typeof p.catch === 'function') {
                p.catch(err => {
                    const nextIndex = sourceIndex + 1;
                    if (nextIndex < NOISER_AUDIO_FALLBACKS.length) {
                        tryPlayNoiser(audio, nextIndex);
                        return;
                    }
                    console.warn('Noiser playback failed:', err);
                });
            }
        } catch (err) {
            const nextIndex = sourceIndex + 1;
            if (nextIndex < NOISER_AUDIO_FALLBACKS.length) {
                tryPlayNoiser(audio, nextIndex);
                return;
            }
            console.warn('Noiser playback failed:', err);
        }
    }

    // Kept synchronous so Safari doesn't lose the user-gesture activation context.
    // async/await before play() can break Safari's audio unlock — plain .catch() is safe.
    function playNoiserSound() {
        const audio = initNoiserAudio();
        if (!audio) return;
        tryPlayNoiser(audio, noiserSourceIndex);
    }

    /* ── Build verse HTML ───────────────────────────────────────── */
    function verseHtml(chNum, v) {
        const r      = ref(chNum, v.verse);
        const rxn    = reactionState[r] || {};
        const bkm    = bookmarkState[r] || false;
        const counts = communityCounts[r] || { emphasize: 0, heart: 0 };
        const bmCnt  = communityBkCounts[r] || 0;
        const hasCommentary = Array.isArray(v.commentary) && v.commentary.length > 0;

        const eA = rxn.emphasize ? ' active' : '';
        const hA = rxn.heart     ? ' active' : '';
        const bA = bkm           ? ' active' : '';
        const eC = fmtCount(counts.emphasize);
        const hC = fmtCount(counts.heart);
        const bC = fmtCount(bmCnt);

        return `<div class="megillah-verse" data-ref="${r}">
<div class="megillah-verse-header">
  <span class="megillah-verse-num" aria-label="Verse ${v.verse}">${v.verse}</span>
</div>
<div class="megillah-verse-hebrew" lang="he">${esc(v.hebrew)}</div>
<div class="megillah-verse-english">${renderEnglishWithNoiser(v.english, r)}</div>
<div class="megillah-verse-reactions">
  <button class="mgv-btn mgv-emphasize${eA}" data-ref="${r}" data-type="emphasize"
          aria-label="Emphasize this verse" title="This verse stands out!">
    <span class="mgv-icon" aria-hidden="true">!</span>
    <span class="mgv-count">${eC}</span>
  </button>
  <button class="mgv-btn mgv-heart${hA}" data-ref="${r}" data-type="heart"
          aria-label="Love this verse" title="I love this verse">
    <span class="mgv-icon" aria-hidden="true">&#x2665;</span>
    <span class="mgv-count">${hC}</span>
  </button>
  <button class="mgv-btn mgv-bookmark${bA}" data-ref="${r}" data-type="bookmark"
          aria-label="Bookmark this verse" title="Save this verse">
    <span class="mgv-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
    </span>
    <span class="mgv-count">${bC}</span>
  </button>
  ${hasCommentary
    ? `<button class="mgv-btn mgv-commentary" data-ref="${r}" data-type="commentary" aria-label="Read commentary for ${r}" title="Read commentary">Read Commentary</button>`
    : ''}
</div>
</div>`;
    }

    /* ── Render ─────────────────────────────────────────────────── */
    function renderChapter(ch) {
        if (!bookData) return;
        const chapters = (ch === 'all')
            ? bookData.chapters
            : bookData.chapters.filter(c => c.chapter === ch);

        let html = '';
        chapters.forEach((chData, idx) => {
            if (idx > 0) {
                const si = icons[(idx + 2) % icons.length];
                html += `<div class="megillah-separator" aria-hidden="true">
  <div class="megillah-separator-line"></div>
  <img src="${si}" alt="" class="megillah-separator-icon">
  <div class="megillah-separator-line"></div>
</div>`;
            }
            const ic = icons[(chData.chapter - 1) % icons.length];
            html += `<div class="megillah-ch-header">
  <img src="${ic}" alt="" class="megillah-ch-icon" aria-hidden="true">
  <div>
    <h2 class="megillah-ch-title">Chapter ${chData.chapter}</h2>
    <p class="megillah-ch-title-he">${chapterNamesHe[chData.chapter]}</p>
  </div>
</div>`;
            chData.verses.forEach(v => { html += verseHtml(chData.chapter, v); });
        });

        content.innerHTML = html;
        attachReactionHandlers();
        attachNoiserHandlers();
    }

    /* ── Update button states without re-rendering ──────────────── */
    function updateButtonStates() {
        content.querySelectorAll('.mgv-btn').forEach(btn => {
            const r    = btn.dataset.ref;
            const type = btn.dataset.type;

            if (!['emphasize', 'heart', 'bookmark'].includes(type)) {
                return;
            }

            let isActive = false;
            let count    = '';

            if (type === 'bookmark') {
                isActive = !!(bookmarkState[r]);
                count    = fmtCount(communityBkCounts[r]);
            } else {
                isActive = !!(reactionState[r] && reactionState[r][type]);
                count    = fmtCount(communityCounts[r] && communityCounts[r][type]);
            }

            btn.classList.toggle('active', isActive);
            const countEl = btn.querySelector('.mgv-count');
            if (countEl) countEl.textContent = count;
        });
    }

    function attachNoiserHandlers() {
        if (noiserHandlersBound) return;
        noiserHandlersBound = true;

        content.addEventListener('click', (event) => {
            const btn = event.target.closest('.mgv-haman-noiser');
            if (!btn) return;

            event.preventDefault();
            event.stopPropagation();
            playNoiserSound();
            btn.classList.remove('is-playing');
            void btn.offsetWidth;
            btn.classList.add('is-playing');
            window.setTimeout(() => btn.classList.remove('is-playing'), 240);
        });
    }

    /* ── Flash auth banner ──────────────────────────────────────── */
    function nudgeAuthBanner() {
        authBanner.hidden = false;
        authBanner.classList.add('esther-auth-banner--flash');
        authBanner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        setTimeout(() => authBanner.classList.remove('esther-auth-banner--flash'), 1400);
    }

    /* ── Reaction button handlers ───────────────────────────────── */
    function attachReactionHandlers() {
        content.querySelectorAll('.mgv-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const r    = btn.dataset.ref;
                const type = btn.dataset.type;

                if (type === 'commentary') {
                    openCommentaryModal(r);
                    return;
                }

                if (!currentUser) {
                    nudgeAuthBanner();
                    return;
                }

                const userId = currentUser.uid;
                btn.disabled = true; // prevent double-click

                try {
                    if (type === 'bookmark') {
                        const wasBookmarked = !!(bookmarkState[r]);
                        if (wasBookmarked) {
                            await removeBookmark(r, userId);
                            bookmarkState[r] = false;
                            communityBkCounts[r] = Math.max(0, (communityBkCounts[r] || 1) - 1);
                        } else {
                            const verseEl = btn.closest('.megillah-verse');
                            const verseText = verseEl?.querySelector('.megillah-verse-english')?.textContent?.slice(0, 140) || '';
                            await addBookmark(r, userId, { verseText });
                            bookmarkState[r] = true;
                            communityBkCounts[r] = (communityBkCounts[r] || 0) + 1;
                        }
                        btn.classList.toggle('active', !!bookmarkState[r]);
                        const countEl = btn.querySelector('.mgv-count');
                        if (countEl) countEl.textContent = fmtCount(communityBkCounts[r]);

                    } else {
                        // emphasize or heart
                        const result = await submitReaction(r, type, userId);
                        const isActive = result.action === 'added';
                        if (!reactionState[r]) reactionState[r] = {};
                        reactionState[r][type] = isActive;
                        if (!communityCounts[r]) communityCounts[r] = { emphasize: 0, heart: 0 };
                        communityCounts[r][type] = Math.max(0,
                            (communityCounts[r][type] || 0) + (isActive ? 1 : -1)
                        );
                        btn.classList.toggle('active', isActive);
                        const countEl = btn.querySelector('.mgv-count');
                        if (countEl) countEl.textContent = fmtCount(communityCounts[r][type]);
                    }
                } catch (err) {
                    console.error('Reaction/bookmark error:', err);
                } finally {
                    btn.disabled = false;
                }
            });
        });
    }

    /* ── Data helpers ───────────────────────────────────────────── */
    function getAllRefs() {
        if (!bookData) return [];
        const refs = [];
        bookData.chapters.forEach(ch => {
            ch.verses.forEach(v => refs.push(ref(ch.chapter, v.verse)));
        });
        return refs;
    }

    // Firestore 'in' queries are capped at 30 items — batch accordingly
    async function batchGetUserReactions(userId, allRefs) {
        const result = {};
        for (let i = 0; i < allRefs.length; i += 30) {
            const batch = allRefs.slice(i, i + 30);
            const batchResult = await getUserReactions(userId, batch);
            Object.assign(result, batchResult);
        }
        return result;
    }

    async function batchGetUserBookmarks(userId, allRefs) {
        const result = {};
        for (let i = 0; i < allRefs.length; i += 30) {
            const batch = allRefs.slice(i, i + 30);
            const batchResult = await getUserBookmarksForVerses(userId, batch);
            Object.assign(result, batchResult);
        }
        return result;
    }

    /* ── Load community counts (no auth required) ───────────────── */
    async function loadCommunityCounts() {
        try {
            const [rxnCounts, bmCounts] = await Promise.all([
                getReactionCountsForBook('Esther'),
                getBookmarkCountsForBook('Esther')
            ]);
            communityCounts   = rxnCounts;
            communityBkCounts = bmCounts;
            updateButtonStates();
        } catch (err) {
            console.error('Error loading community counts:', err);
        }
    }

    /* ── Load user-specific state ───────────────────────────────── */
    async function loadUserState(userId) {
        const allRefs = getAllRefs();
        try {
            // getUserReactions returns { "Esther 1:1": ['emphasize', 'heart'], ... }
            const [userRxnsRaw, userBkms] = await Promise.all([
                batchGetUserReactions(userId, allRefs),
                batchGetUserBookmarks(userId, allRefs)
            ]);

            // Convert array format to { emphasize: true, heart: true }
            reactionState = {};
            Object.entries(userRxnsRaw).forEach(([r, types]) => {
                reactionState[r] = {};
                types.forEach(t => { reactionState[r][t] = true; });
            });

            bookmarkState = userBkms;
            updateButtonStates();
        } catch (err) {
            console.error('Error loading user state:', err);
        }
    }

    /* ── Bootstrap ──────────────────────────────────────────────── */

    setupCommentaryModal();
    initNoiserAudio();

    // 1. Fetch and render the Megillah text
    fetch('data/bookofesther.json')
        .then(r => r.json())
        .then(data => {
            bookData = data;
            commentaryByRef = {};
            bookData.chapters.forEach((chapter) => {
                chapter.verses.forEach((verse) => {
                    if (Array.isArray(verse.commentary) && verse.commentary.length > 0) {
                        commentaryByRef[ref(chapter.chapter, verse.verse)] = verse.commentary;
                    }
                });
            });
            renderChapter('all');
            loadCommunityCounts();
            if (currentUser?.uid) {
                loadUserState(currentUser.uid);
            }
        })
        .catch(() => {
            content.innerHTML = '<p class="megillah-loading">Unable to load the Megillah. Please refresh the page.</p>';
        });

    // 2. Watch auth — load user reactions when signed in, show banner when not
    onAuthStateChanged(auth, user => {
        currentUser = user;
        if (user) {
            authBanner.hidden = true;
            if (bookData) {
                loadUserState(user.uid);
            }
        } else {
            authBanner.hidden = false;
            reactionState  = {};
            bookmarkState  = {};
            updateButtonStates();
        }
    });

    // 3. Chapter tab clicks
    navBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            navBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const ch = btn.dataset.ch === 'all' ? 'all' : parseInt(btn.dataset.ch, 10);
            renderChapter(ch);
            content.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
    });
    </script>

</body>
</html>
